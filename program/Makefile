.PHONY: setup-deps test test-all test-integration build clean generate-idl generate-clients fmt deploy-devnet

# Install dependencies
install:
	pnpm install

# Generate IDL from Shank annotations
generate-idl:
	@echo "Generating IDL..."
	pnpm run generate-idl

# Generate clients from IDL using Codama
generate-clients: generate-idl
	@echo "Generating clients..."
	pnpm run generate-clients

# Build the program
build:
	cargo-build-sbf
	make generate-idl
	make generate-clients

# Build the program with devnet feature
build-devnet:
	cargo-build-sbf --features devnet
	make generate-idl
	make generate-clients

# Setup test dependencies using solana program download
setup-deps:
	@echo "Setting up test dependencies..."
	@mkdir -p tests/integration-tests/deps
	@echo "Downloading SPL Token program..."
	solana program dump TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA tests/integration-tests/deps/spl_token.so -u mainnet-beta
	@echo "Downloading SPL Associated Token Account program..."
	solana program dump ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL tests/integration-tests/deps/spl_associated_token_account.so -u mainnet-beta
	@echo "Dependencies downloaded successfully!"

# Run unit tests in program/
test:
	@echo "Running unit tests..."
	@cd program && cargo test

# Run integration tests (includes setup-deps and build)
test-integration: build setup-deps
	@echo "Running integration tests..."
	@cd tests/integration-tests && cargo test -- --nocapture

# Run all tests (unit + integration)
test-all: test test-integration

# Format code and run clippy
fmt:
	cargo fmt --all
	@cd program && cargo clippy --fix --allow-dirty --all-targets -- -D warnings
	@cd tests/integration-tests && cargo clippy --fix --allow-dirty --all-targets -- -D warnings

# Deploy to devnet
deploy-devnet: build-devnet
	@echo "Deploying to devnet..."
	@if [ -z "$(DEPLOYER_KEY)" ]; then \
		echo "Error: DEPLOYER_KEY parameter is required. Usage: make deploy-devnet DEPLOYER_KEY=/path/to/deployer-keypair.json"; \
		exit 1; \
	fi
	solana program deploy target/deploy/commerce_program.so \
		--program-id target/deploy/commerce_program-keypair.json \
		--keypair $(DEPLOYER_KEY) \
		--url devnet

# Clean build artifacts
clean:
	cargo clean
	rm -rf tests/integration-tests/deps
